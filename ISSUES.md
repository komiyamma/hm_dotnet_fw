# hm.NET プロジェクトの問題点

このドキュメントは、`hm.NET` プロジェクトの現状分析と、考えられる問題点をまとめたものです。

---

## 1. ソースコードの文字化け

C++ソースコード (`hm.NET.src/hmNET/hmNET.cpp`) 内のコメントが、エンコーディングの問題により文字化けしています。

- **問題点:**
  - 元のエンコーディングがおそらくShift-JISであるのに対し、現在の環境では異なるエンコーディング（UTF-8など）で解釈されているため、コメントが読めなくなっています。
  - これにより、コードの意図を理解することが著しく困難になり、メンテナンス性が大幅に低下しています。

- **提案:**
  - ファイルのエンコーディングをUTF-8に変換し、文字化けを修正する必要があります。

## 2. 古い開発環境への依存

このプロジェクトは、現在では古い開発環境に依存している可能性が高いです。

- **問題点:**
  - `VS2017.md` というファイルが存在することから、Visual Studio 2017 での開発が想定されていたと推測されます。
  - C++/CLI、特定のバージョンの .NET Framework (4.5-4.8) といった、現代の開発環境では標準的ではない技術要素に依存しています。
  - 新しい開発者がビルド環境を構築することが困難である可能性があります。

- **提案:**
  - ビルド手順を明確化し、必要なツールセットをドキュメント化することが推奨されます。
  - 将来的には、よりモダンなビルドシステムへの移行を検討すべきです。

## 3. 技術的負債と近代化の課題

プロジェクトは、現在の標準から見ると古い技術スタックを使用しています。

- **問題点:**
  - **.NET Frameworkへの依存:** .NET Framework は現在メンテナンスモードであり、新機能の追加は行われません。パフォーマンスやセキュリティの面で、最新の .NET (.NET 6/8など) に劣ります。
  - **C++/CLIの使用:** C++/CLIは強力な相互運用技術ですが、複雑さが高いです。最新の.NETでは、`UnmanagedCallersOnly` 属性など、よりシンプルでパフォーマンスの高い相互運用のための仕組みが提供されています。

- **提案:**
  - 長期的な視点で、.NET への移行を計画することが望ましいです。これにより、パフォーマンスの向上、最新のC#機能の活用、コミュニティサポートの享受といったメリットが得られます。

## 4. 複雑で壊れやすい相互運用ロジック

秀丸マクロ、C++、C# という3つの異なる環境を連携させるためのロジックが非常に複雑です。

- **問題点:**
  - **リフレクションの多用:** C#側では、リフレクションを用いて動的にメソッドを呼び出しています。これは柔軟ですが、コンパイル時の型チェックが効かず、実行時エラー（メソッドが見つからない、引数の型が違うなど）の原因となりやすいです。
  - **手動での型変換:** C++層で、秀丸マクロから渡された引数の型を一つ一つ判定し、手動で.NETの型に変換しています。この処理は冗長であり、間違いが発生しやすい箇所です。
  - **エラー伝達:** エラーが発生した場合、`System.Diagnostics.Trace` にログを出力するだけで、マクロ側にエラーが明確に伝わらない可能性があります。

- **提案:**
  - 可能な限りリフレクションの使用を減らし、静的な型付けの利点を活かせるような設計に変更することを検討します。
  - エラーハンドリング機構を改善し、より構造化されたエラー情報を呼び出し元（マクロ）に返せるようにするべきです。

## 5. 自動テストの欠如

プロジェクト内に、単体テストや結合テストなどの自動テストスイートが見当たりません。

- **問題点:**
  - コードの変更が既存の機能に悪影響（リグレッション）を与えていないかを確認する術が、手動テストしかありません。
  - これでは、リファクタリングや機能追加を安全かつ迅速に行うことが困難です。

- **提案:**
  - NUnit や MSTest などのテストフレームワークを導入し、まずは重要な機能からテストコードを作成していくことが不可欠です。

## 6. 静的変数による状態管理

ライブラリ全体で、`static` 変数が多用され、グローバルな状態を保持しています。

- **問題点:**
  - `static` 変数への依存は、コードの見通しを悪くし、特定の部分だけを分離してテストすることを難しくします。
  - 将来的に、もし複数のスレッドから同時にライブラリが使用されるような状況が発生した場合、スレッドセーフではないため、競合状態や予期せぬ不具合を引き起こす原因となります。

- **提案:**
  - 状態を管理するための専用のクラスを導入し、インスタンス経由で状態にアクセスするようにリファクタリングすることを検討します。

## 7. ドキュメントの不足

APIの仕様や使い方に関するドキュメントが不足しています。

- **問題点:**
  - `README.md` に記載されていた作者のウェブサイトが、現在アクセス不能になっています。
  - C#のソースコードにはXMLドキュメントコメントが付与されておらず、IntelliSenseによる補完やAPIリファレンスの自動生成ができません。
  - ライブラリの利用者が、どのようにして各機能を使えばよいのかをソースコードから読み解く必要があり、学習コストが高くなっています。

- **提案:**
  - C#の公開APIに対して、XMLドキュメントコメントを整備します。
  - ライブラリの基本的な使い方や、主要なクラス・メソッドの役割を説明するドキュメント（例: `USAGE.md`）を作成します。
